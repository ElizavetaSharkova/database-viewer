{"ast":null,"code":"'use strict';\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nvar Sender = require('./sender').Sender;\n\nvar SQL_SERVER_BROWSER_PORT = 1434;\nvar TIMEOUT = 2 * 1000;\nvar RETRIES = 3; // There are three bytes at the start of the response, whose purpose is unknown.\n\nvar MYSTERY_HEADER_LENGTH = 3; // Most of the functionality has been determined from from jTDS's MSSqlServerInfo class.\n\nvar InstanceLookup = function () {\n  function InstanceLookup() {\n    (0, _classCallCheck3.default)(this, InstanceLookup);\n  } // Wrapper allows for stubbing Sender when unit testing instance-lookup.\n\n\n  (0, _createClass3.default)(InstanceLookup, [{\n    key: 'createSender',\n    value: function createSender(host, port, request) {\n      return new Sender(host, port, request);\n    }\n  }, {\n    key: 'instanceLookup',\n    value: function instanceLookup(options, callback) {\n      var _this = this;\n\n      var server = options.server;\n\n      if (typeof server !== 'string') {\n        throw new TypeError('Invalid arguments: \"server\" must be a string');\n      }\n\n      var instanceName = options.instanceName;\n\n      if (typeof instanceName !== 'string') {\n        throw new TypeError('Invalid arguments: \"instanceName\" must be a string');\n      }\n\n      var timeout = options.timeout === undefined ? TIMEOUT : options.timeout;\n\n      if (typeof timeout !== 'number') {\n        throw new TypeError('Invalid arguments: \"timeout\" must be a number');\n      }\n\n      var retries = options.retries === undefined ? RETRIES : options.retries;\n\n      if (typeof retries !== 'number') {\n        throw new TypeError('Invalid arguments: \"retries\" must be a number');\n      }\n\n      if (typeof callback !== 'function') {\n        throw new TypeError('Invalid arguments: \"callback\" must be a function');\n      }\n\n      var sender = void 0,\n          timer = void 0,\n          retriesLeft = retries;\n\n      var onTimeout = function onTimeout() {\n        sender.cancel();\n        makeAttempt();\n      };\n\n      var makeAttempt = function makeAttempt() {\n        if (retriesLeft > 0) {\n          retriesLeft--;\n          var request = new Buffer([0x02]);\n          sender = _this.createSender(options.server, SQL_SERVER_BROWSER_PORT, request);\n          sender.execute(function (err, message) {\n            clearTimeout(timer);\n\n            if (err) {\n              callback('Failed to lookup instance on ' + server + ' - ' + err.message);\n              return;\n            } else {\n              message = message.toString('ascii', MYSTERY_HEADER_LENGTH);\n\n              var port = _this.parseBrowserResponse(message, instanceName);\n\n              if (port) {\n                callback(undefined, port);\n              } else {\n                callback('Port for ' + instanceName + ' not found in ' + options.server);\n              }\n            }\n          });\n          timer = setTimeout(onTimeout, timeout);\n        } else {\n          callback('Failed to get response from SQL Server Browser on ' + server);\n        }\n      };\n\n      makeAttempt();\n    }\n  }, {\n    key: 'parseBrowserResponse',\n    value: function parseBrowserResponse(response, instanceName) {\n      var getPort = void 0;\n      var instances = response.split(';;');\n\n      for (var i = 0, len = instances.length; i < len; i++) {\n        var instance = instances[i];\n        var parts = instance.split(';');\n\n        for (var p = 0, partsLen = parts.length; p < partsLen; p += 2) {\n          var name = parts[p];\n          var value = parts[p + 1];\n\n          if (name === 'tcp' && getPort) {\n            var port = parseInt(value, 10);\n            return port;\n          }\n\n          if (name === 'InstanceName') {\n            if (value.toUpperCase() === instanceName.toUpperCase()) {\n              getPort = true;\n            } else {\n              getPort = false;\n            }\n          }\n        }\n      }\n    }\n  }]);\n  return InstanceLookup;\n}();\n\nmodule.exports.InstanceLookup = InstanceLookup;","map":null,"metadata":{},"sourceType":"script"}